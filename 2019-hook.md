# Hook parameters

```
  -port int
        Port to listen on. (default 8888)
  -grace-period duration
        On shutdown, try to handle remaining events for the specified duration.  (default 3m0s)
```
Hook is a server, so it listens on a port, which is configurable. I do not know
yet what does it actually "serve", but I assume it only listens for GitHub
webhook callbacks. Graceful shutdown gives Hook an opportunity to finish
in-progress events in few minutes after stopping to accept incoming calls.

```
  -config-path string
        Path to config.yaml.
  -job-config-path string
        Path to prow job configs.
  -plugin-config string
        Path to plugin config file. (default "/etc/plugins/plugins.yaml")
```

These files configure Prow as a whole. I think only config-path and
plugin-config are used by Hook, not job config, but I'll investigate config
structure later.

```
  -build-cluster string
        Path to kube.Cluster YAML file. If empty, uses the local cluster. All clusters are used as build clusters. Cannot be combined with --kubeconfig.
  -kubeconfig string
        Path to .kube/config file. If empty, uses the local cluster. All contexts other than the default or whichever is passed to --context are used as build clusters.
  -deck-url string
        Deck URI for read-only access to the infrastructure cluster.
```
`
All these are parts of a Kubernetes parameters structure that is shared in all
Prow. I think Hook should not use these much, if at all.

```
  -github-endpoint value
        GitHub's API endpoint (may differ for enterprise). (default https://api.github.com)
  -github-graphql-endpoint string
        GitHub GraphQL API endpoint (may differ for enterprise). (default "https://api.github.com/graphql")
  -github-token-path string
        Path to the file containing the GitHub OAuth secret. (default "/etc/github/oauth")
```
All these are parts of GitHub parameters structure that is shared in all Prow.
It configures the way how Prow calls GitHub APIs (endpoints and authentication)

```
  -hmac-secret-file string
        Path to the file containing the GitHub HMAC secret. (default "/etc/webhook/hmac")
```
HMAC is a secret that is used to validate (both integrity and authentication)
incoming webhook calls.

```
  -slack-token-file string
        Path to the file containing the Slack token to use.
```
This token is likely to be used to call Slack API for something, but I don't
know what.

# High-level procedure
1. Process and validate parameters. Currently, only the the shared groups
   (kubernetes and GitHub) perform some validations.
2. Set up logger to identify logs from hook component. Most of Prow uses logrus
   for logging.
3. Create a ConfigAgent and start it
4. Create a SecretAgent, initialize it with paths to secrets (GH HMAC, Slack
   and GH token) and start it
5. Create a GitHubClient and pass the SecretAgent to it
6. Create a GitCient and pass the SecretAgent to it 

# ConfigAgent
ConfigAgent is a structure that loads both Prow and Job configs from disk once,
then starts a goroutine that polls the files on disk for changes and reloads
the configs on change. The watching goroutine uses Stat() in a loop to detect
changes, not inotify as I would expect (but maybe it's easier to poll for few
files). The watcher reloads the configs periodically even if no change was
detected, because simultaneous writes can be not-detected by a mtime-based
check. Clients can use the ConfigAgent to get an up-to-date config, which is
needed for long-running services like Hook. Because the reloading is
asynchronous and requests for configs can come at any time, ConfigAgent uses
mutexes to avoid races.
ConfigAgent also provides a mechanism for clients to subscribe for changes in
the config. The client subscribes to changes by providing a channel on which it
wants to receive config deltas. Config delta is a structure consisting of the
former and current config, sent by the ConfigAgent to all subscribed channels
whenever new Config is loaded.

# SecretAgent
SecretAgent is similar to ConfigAgent in purpose - it maintains a map of file
paths to their contents (the actual secrets), watches these paths for changes
and reloads the content whenever they change, or after a time period without a
change anyways (just to be sure). There is a separate goroutine watching each
file. SecretAgent does not have a change-notification mechanism like
ConfigAgent does.

# GitHubClient
GitHubClient is a client for communication with GitHub. It is created via the
`GitHubOptions` object from the `flagutils.github` package. The actual
GitHubClient is defined in `github` package and is a struct with a logger, time
(not sure what it is), a githubql Enterprise client (from external 
github.com/shurcooL/githubv4 package), a http client, bases (which I assume is
a set of endpoints to try in a sequence) and a function to get the current
value of the OAuth token (the function is provided by the SecretAgent). The struct
also knows whether it is a dry client which prevents it from executing modifying
calls to GitHub.

The GitHub client communicates with GH over HTTPS, with several layers of request
logic. The lowest layer, the `doRequest` method, marshals the body, obtains the
token value, sets `Authorization` and `Accept` headers and uses the
`HttpClient.Do` method to perform the actual call. The layer above it, the
`requestRetry` method, handles retries and various error cases, and is the most
complicated layer of all. The handle/retry logic overview:

1. A predefined maximum amount of retries is performed, hardcoded as a constant 8
2. There is an exponential backoff between retries
3. On a connection problem, the logic switches to a next GH host (rotates).
4. 404 are only retried fewer time (2, constant) to avoid burning token on lost
   cases
5. 

# GitClient
GitClient is a wrapper over the local `git` command. Like `GitHubClient`, it is
created indirectly by the `GitHubOptions` object from the `flagutils.github`
package. `GitClient` is a struct defined in the `git` package with the following
members: a logger, remote username with an associated token-obtaining function
(again, provided by the SecretAgent, returning the OAuth token) and a mutex lock,
a path to the `git` executable, a temporary dir path, a logger, a URL base
(currently harcoded to "github.com") and a map of mutex locks, presumably to lock
operations over a single git repository. Inclusion of the GH URL base and
credentials looks like `GitClient` expects to be used mostly for manipulating
local clones of GitHub repositories. When GitClient is created, a GitHubClient
instance (created just for this purpose) is used to obtain the GH username for the
given token.
